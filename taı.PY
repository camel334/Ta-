import sys
import time
import subprocess  # Paket yÃ¼kleme iÃ§in eklendi
import pyautogui
import google.generativeai as genai
from PIL import Image
from PyQt5.QtCore import Qt, QTimer, QObject, pyqtSignal
from PyQt5.QtGui import QImage, QPixmap, QColor, QFont
from PyQt5.QtWidgets import (QApplication, QWidget, QPushButton, QLabel, QVBoxLayout, QHBoxLayout, 
                           QLineEdit, QFileDialog, QTextEdit, QGraphicsDropShadowEffect, 
                           QSizePolicy, QFrame, QScrollArea, QCheckBox, QDialog, QMessageBox)
import threading
import os
import datetime

# Gerekli paketleri kontrol et ve eksik olanlarÄ± yÃ¼kle
def check_and_install_packages():
    packages = [
        "pyautogui",
        "google-generativeai",
        "pillow",
        "PyQt5"
    ]
    
    for package in packages:
        try:
            if package == "pillow":
                __import__("PIL")
            elif package == "PyQt5":
                __import__("PyQt5")
            elif package == "google-generativeai":
                __import__("google.generativeai")
            else:
                __import__(package)
            print(f"{package} zaten yÃ¼klÃ¼.")
        except ImportError:
            print(f"{package} bulunamadÄ±, yÃ¼kleniyor...")
            try:
                subprocess.run([sys.executable, "-m", "pip", "install", package], check=True)
                print(f"{package} baÅŸarÄ±yla yÃ¼klendi.")
            except subprocess.CalledProcessError:
                print(f"{package} yÃ¼klenirken hata oluÅŸtu!")

# Uygulama baÅŸlamadan Ã¶nce paketleri kontrol et
check_and_install_packages()

# API anahtarÄ± diyalogu
class APIKeyDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Gemini API AnahtarÄ±")
        self.setWindowFlags(self.windowFlags() & ~Qt.WindowContextHelpButtonHint)
        self.setStyleSheet("""
            QDialog {
                background-color: #343541;
                color: white;
                font-family: 'Arial';
            }
            QLabel {
                color: white;
                font-size: 14px;
            }
            QLineEdit {
                background-color: #40414f;
                color: white;
                border: 1px solid #565869;
                border-radius: 5px;
                padding: 8px;
                font-size: 14px;
            }
            QPushButton {
                background-color: #4285f4;
                color: white;
                border-radius: 5px;
                padding: 8px 16px;
                font-size: 14px;
            }
            QPushButton:hover {
                background-color: #4285f4cc;
            }
            QTextEdit {
                background-color: #40414f;
                color: white;
                border-radius: 5px;
                padding: 8px;
                font-size: 12px;
            }
        """)
        
        self.api_key = ""
        self.initUI()
        
    def initUI(self):
        layout = QVBoxLayout()
        layout.setSpacing(15)
        
        # BaÅŸlÄ±k ve aÃ§Ä±klama
        title_label = QLabel("Gemini API AnahtarÄ±nÄ± Girin")
        title_label.setStyleSheet("font-size: 18px; font-weight: bold;")
        layout.addWidget(title_label)
        
        info_label = QLabel("TAI'yi kullanmak iÃ§in Google Gemini API anahtarÄ± gereklidir. "
                          "EÄŸer API anahtarÄ±nÄ±z yoksa aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyebilirsiniz.")
        info_label.setWordWrap(True)
        layout.addWidget(info_label)
        
        # API anahtarÄ± alanÄ±
        key_layout = QVBoxLayout()
        key_label = QLabel("API AnahtarÄ±:")
        self.key_input = QLineEdit()
        self.key_input.setPlaceholderText("Gemini API anahtarÄ±nÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n")
        key_layout.addWidget(key_label)
        key_layout.addWidget(self.key_input)
        layout.addLayout(key_layout)
        
        # API anahtarÄ± alma talimatlarÄ±
        instructions = QTextEdit()
        instructions.setReadOnly(True)
        instructions.setText("API AnahtarÄ± Alma AdÄ±mlarÄ±:\n\n"
                             "1. https://aistudio.google.com/app/apikey adresine gidin\n"
                             "2. Google hesabÄ±nÄ±zla giriÅŸ yapÄ±n\n"
                             "3. 'Create API Key' butonuna tÄ±klayÄ±n\n"
                             "4. OluÅŸturulan API anahtarÄ±nÄ± kopyalayÄ±n\n"
                             "5. YukarÄ±daki alana yapÄ±ÅŸtÄ±rÄ±n\n\n"
                             "API anahtarÄ±nÄ±z gÃ¼venle saklanacaktÄ±r.")
        instructions.setFixedHeight(150)
        layout.addWidget(instructions)
        
        # Butonlar
        button_layout = QHBoxLayout()
        self.ok_button = QPushButton("Tamam")
        self.ok_button.clicked.connect(self.accept_key)
        self.cancel_button = QPushButton("Ä°ptal")
        self.cancel_button.clicked.connect(self.reject)
        self.cancel_button.setStyleSheet("background-color: #f44336;")
        
        button_layout.addStretch()
        button_layout.addWidget(self.cancel_button)
        button_layout.addWidget(self.ok_button)
        layout.addLayout(button_layout)
        
        self.setLayout(layout)
        self.resize(450, 400)
        
    def accept_key(self):
        self.api_key = self.key_input.text().strip()
        if not self.api_key:
            QMessageBox.warning(self, "UyarÄ±", "API anahtarÄ± boÅŸ olamaz!")
            return
        
        # Minimal API anahtarÄ± kontrolÃ¼ (format ve uzunluk kontrolÃ¼)
        if not self.api_key.startswith("AIza") or len(self.api_key) < 30:
            response = QMessageBox.warning(
                self, 
                "GeÃ§ersiz API AnahtarÄ±", 
                "GirdiÄŸiniz API anahtarÄ± geÃ§ersiz gÃ¶rÃ¼nÃ¼yor. Devam etmek istiyor musunuz?", 
                QMessageBox.Yes | QMessageBox.No
            )
            if response == QMessageBox.No:
                return
        
        self.accept()

# Gemini API anahtarÄ±
GEMINI_API_KEY = ""

# UI gÃ¼ncellemesi iÃ§in sinyal sÄ±nÄ±fÄ±
class UISignals(QObject):
    update_ui = pyqtSignal(object)
    show_error = pyqtSignal(object, object)

class ChatMessage(QFrame):
    def __init__(self, text, is_user=False, parent=None):
        super().__init__(parent)
        self.setObjectName("chatMessage")
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 10, 20, 10)
        
        # Mesaj metni
        self.message = QTextEdit()
        self.message.setReadOnly(True)
        self.message.setPlainText(text)
        self.message.setFrameStyle(QFrame.NoFrame)
        self.message.setMinimumHeight(30)
        self.message.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Minimum)
        self.message.document().setDocumentMargin(2)
        self.message.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        
        # KullanÄ±cÄ± ya da AI mesajÄ± stilini ayarla
        if is_user:
            self.setStyleSheet("""
                QFrame#chatMessage {
                    background-color: #343541;
                    border-top: 1px solid #444654;
                    border-bottom: 1px solid #444654;
                }
                QTextEdit {
                    background-color: transparent;
                    color: white;
                    font-size: 15px;
                    border: none;
                }
            """)
        else:
            self.setStyleSheet("""
                QFrame#chatMessage {
                    background-color: #444654;
                    border-top: 1px solid #343541;
                    border-bottom: 1px solid #343541;
                }
                QTextEdit {
                    background-color: transparent;
                    color: white;
                    font-size: 15px;
                    border: none;
                }
            """)
        
        layout.addWidget(self.message)
        self.setLayout(layout)

class App(QWidget):
    def __init__(self):
        super().__init__()
        
        # API anahtarÄ±nÄ± sor
        self.get_api_key()
        
        # API anahtarÄ± yoksa uygulamayÄ± kapat
        if not GEMINI_API_KEY:
            sys.exit()
            
        # API anahtarÄ±nÄ± ayarla
        genai.configure(api_key=GEMINI_API_KEY)

        self.setWindowTitle('TAI - Yapay Zeka AsistanÄ±')
        self.setGeometry(100, 100, 1000, 800)
        self.setStyleSheet("""
            QWidget {
                background-color: #343541;
                font-family: 'Arial';
                color: white;
            }
        """)
        
        # GÃ¶rsel analizi iÃ§in deÄŸiÅŸkenler
        self.current_image_path = None
        
        # Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in deÄŸiÅŸkenler
        self.screenshot_dir = "screenshots"
        self.is_auto_screenshot_enabled = False
        self.screenshot_timer = QTimer(self)
        self.screenshot_timer.timeout.connect(self.take_auto_screenshot)
        
        # UI gÃ¼ncellemeleri iÃ§in sinyal
        self.ui_signals = UISignals()
        self.ui_signals.update_ui.connect(self.on_update_ui)
        self.ui_signals.show_error.connect(self.on_show_error)
        
        # Screenshots klasÃ¶rÃ¼nÃ¼ oluÅŸtur
        if not os.path.exists(self.screenshot_dir):
            os.makedirs(self.screenshot_dir)

        self.initUI()
        
    def get_api_key(self):
        """KullanÄ±cÄ±dan API anahtarÄ± alÄ±r"""
        global GEMINI_API_KEY
        
        # Daha Ã¶nce kaydedilmiÅŸ API anahtarÄ±nÄ± kontrol et
        api_key_file = os.path.join(os.path.expanduser("~"), ".tai_api_key")
        
        if os.path.exists(api_key_file):
            try:
                with open(api_key_file, "r") as f:
                    saved_key = f.read().strip()
                    if saved_key:
                        # API anahtarÄ±nÄ± doÄŸrulamak iÃ§in bir onay mesajÄ± gÃ¶ster
                        response = QMessageBox.question(
                            None,
                            "KayÄ±tlÄ± API AnahtarÄ±",
                            "KayÄ±tlÄ± API anahtarÄ±nÄ±z bulundu. Bu anahtarÄ± kullanmak istiyor musunuz?",
                            QMessageBox.Yes | QMessageBox.No
                        )
                        
                        if response == QMessageBox.Yes:
                            GEMINI_API_KEY = saved_key
                            return
            except Exception as e:
                print(f"API anahtarÄ± okuma hatasÄ±: {e}")
        
        # API anahtarÄ± diyaloÄŸunu gÃ¶ster
        dialog = APIKeyDialog()
        result = dialog.exec_()
        
        if result == QDialog.Accepted and dialog.api_key:
            GEMINI_API_KEY = dialog.api_key
            
            # API anahtarÄ±nÄ± kaydetme seÃ§eneÄŸi sor
            save_response = QMessageBox.question(
                None,
                "API AnahtarÄ±nÄ± Kaydet",
                "API anahtarÄ±nÄ±zÄ± bilgisayarÄ±nÄ±za kaydetmek istiyor musunuz?\n"
                "Bu sayede uygulamayÄ± her aÃ§tÄ±ÄŸÄ±nÄ±zda tekrar girmenize gerek kalmaz.",
                QMessageBox.Yes | QMessageBox.No
            )
            
            if save_response == QMessageBox.Yes:
                try:
                    with open(api_key_file, "w") as f:
                        f.write(GEMINI_API_KEY)
                    QMessageBox.information(None, "BaÅŸarÄ±lÄ±", "API anahtarÄ±nÄ±z kaydedildi.")
                except Exception as e:
                    QMessageBox.warning(None, "Hata", f"API anahtarÄ± kaydedilemedi: {str(e)}")

    def initUI(self):
        main_layout = QVBoxLayout()
        main_layout.setSpacing(0)
        main_layout.setContentsMargins(0, 0, 0, 0)

        # BaÅŸlÄ±k kÄ±smÄ±
        title_frame = QFrame()
        title_frame.setStyleSheet("background-color: #444654; border-bottom: 1px solid #565869;")
        title_layout = QHBoxLayout(title_frame)
        
        title_label = QLabel("TAI - TÃ¼rkÃ§e Yapay Zeka AsistanÄ±")
        title_label.setStyleSheet("font-size: 18px; font-weight: bold; color: white;")
        title_layout.addWidget(title_label, alignment=Qt.AlignCenter)
        
        # API AnahtarÄ± deÄŸiÅŸtirme butonu
        api_button = QPushButton("API AnahtarÄ±nÄ± DeÄŸiÅŸtir")
        api_button.setStyleSheet("""
            QPushButton {
                background-color: transparent;
                color: #cccccc;
                border: none;
                font-size: 12px;
            }
            QPushButton:hover {
                color: white;
                text-decoration: underline;
            }
        """)
        api_button.clicked.connect(self.change_api_key)
        title_layout.addWidget(api_button, alignment=Qt.AlignRight)
        
        main_layout.addWidget(title_frame)

        # Mesaj geÃ§miÅŸi alanÄ±
        self.messages_area = QScrollArea()
        self.messages_area.setWidgetResizable(True)
        self.messages_area.setFrameStyle(QFrame.NoFrame)
        self.messages_area.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        
        self.messages_container = QWidget()
        self.messages_layout = QVBoxLayout(self.messages_container)
        self.messages_layout.setSpacing(0)
        self.messages_layout.setContentsMargins(0, 0, 0, 0)
        self.messages_layout.addStretch()
        
        self.messages_area.setWidget(self.messages_container)
        main_layout.addWidget(self.messages_area, 1)

        # HoÅŸgeldin mesajÄ±
        welcome_message = ChatMessage("Merhaba! Ben TAI, TÃ¼rkÃ§e yapay zeka asistanÄ±nÄ±zÄ±m. Size nasÄ±l yardÄ±mcÄ± olabilirim?", is_user=False)
        self.messages_layout.addWidget(welcome_message)

        # Alt kÄ±sÄ±m - mesaj gÃ¶nderme alanÄ±
        bottom_frame = QFrame()
        bottom_frame.setStyleSheet("""
            QFrame {
                background-color: #343541;
                border-top: 1px solid #565869;
                padding: 10px;
            }
        """)
        bottom_layout = QVBoxLayout(bottom_frame)
        
        # Mesaj giriÅŸ alanÄ±
        input_frame = QFrame()
        input_frame.setStyleSheet("""
            QFrame {
                background-color: #40414f;
                border-radius: 12px;
                margin: 10px 100px;
            }
        """)
        input_layout = QHBoxLayout(input_frame)
        
        self.chat_input = QLineEdit()
        self.chat_input.setPlaceholderText("Herhangi bir ÅŸey sor")
        self.chat_input.setStyleSheet("""
            QLineEdit {
                background-color: transparent;
                border: none;
                color: white;
                font-size: 15px;
                padding: 8px;
            }
        """)
        self.chat_input.returnPressed.connect(self.send_message)
        
        send_button = QPushButton()
        send_button.setIcon(self.style().standardIcon(self.style().SP_ArrowRight))
        send_button.setStyleSheet("""
            QPushButton {
                background-color: transparent;
                border: none;
                color: white;
                padding: 8px;
            }
            QPushButton:hover {
                background-color: #565869;
                border-radius: 4px;
            }
        """)
        send_button.clicked.connect(self.send_message)
        
        input_layout.addWidget(self.chat_input)
        input_layout.addWidget(send_button)
        
        bottom_layout.addWidget(input_frame)
        
        # Kontrol butonlarÄ±
        control_layout = QHBoxLayout()
        
        self.upload_button = QPushButton("GÃ¶rsel YÃ¼kle")
        self.upload_button.setStyleSheet(self.button_style("#3e8e41"))
        self.upload_button.clicked.connect(self.open_file)
        
        self.analyze_button = QPushButton("GÃ¶rseli Analiz Et")
        self.analyze_button.setStyleSheet(self.button_style("#f4b400"))
        self.analyze_button.clicked.connect(self.analyze_image_with_ai)
        self.analyze_button.setEnabled(False)  # BaÅŸlangÄ±Ã§ta devre dÄ±ÅŸÄ±
        
        self.screenshot_button = QPushButton("Ekran GÃ¶rÃ¼ntÃ¼sÃ¼ Al")
        self.screenshot_button.setStyleSheet(self.button_style("#4285f4"))
        self.screenshot_button.clicked.connect(self.take_screenshot)
        
        self.auto_screenshot_checkbox = QCheckBox("Dakikada Bir Ekran Analizi")
        self.auto_screenshot_checkbox.setStyleSheet("""
            QCheckBox {
                color: white;
                font-size: 14px;
                padding: 8px 16px;
            }
            QCheckBox::indicator {
                width: 18px;
                height: 18px;
            }
        """)
        self.auto_screenshot_checkbox.stateChanged.connect(self.toggle_auto_screenshot)
        
        control_layout.addStretch()
        control_layout.addWidget(self.upload_button)
        control_layout.addWidget(self.analyze_button)
        control_layout.addWidget(self.screenshot_button)
        control_layout.addWidget(self.auto_screenshot_checkbox)
        control_layout.addStretch()
        
        bottom_layout.addLayout(control_layout)
        
        main_layout.addWidget(bottom_frame)
        
        self.setLayout(main_layout)
        
        # GÃ¶rsel Ã¶nizleme alanÄ± (baÅŸlangÄ±Ã§ta gizli)
        self.image_preview = QLabel()
        self.image_preview.setAlignment(Qt.AlignCenter)
        self.image_preview.setStyleSheet("padding: 10px;")
        self.image_preview.hide()
        self.messages_layout.addWidget(self.image_preview)
    
    def change_api_key(self):
        """API anahtarÄ±nÄ± deÄŸiÅŸtirme fonksiyonu"""
        global GEMINI_API_KEY
        
        dialog = APIKeyDialog()
        result = dialog.exec_()
        
        if result == QDialog.Accepted and dialog.api_key:
            old_key = GEMINI_API_KEY
            GEMINI_API_KEY = dialog.api_key
            
            # API anahtarÄ±nÄ± kaydetme seÃ§eneÄŸi sor
            save_response = QMessageBox.question(
                self,
                "API AnahtarÄ±nÄ± Kaydet",
                "Yeni API anahtarÄ±nÄ±zÄ± bilgisayarÄ±nÄ±za kaydetmek istiyor musunuz?",
                QMessageBox.Yes | QMessageBox.No
            )
            
            if save_response == QMessageBox.Yes:
                api_key_file = os.path.join(os.path.expanduser("~"), ".tai_api_key")
                try:
                    with open(api_key_file, "w") as f:
                        f.write(GEMINI_API_KEY)
                    QMessageBox.information(self, "BaÅŸarÄ±lÄ±", "Yeni API anahtarÄ±nÄ±z kaydedildi.")
                except Exception as e:
                    QMessageBox.warning(self, "Hata", f"API anahtarÄ± kaydedilemedi: {str(e)}")
            
            # Genai yapÄ±landÄ±rmasÄ±nÄ± gÃ¼ncelle
            genai.configure(api_key=GEMINI_API_KEY)
            
            # KullanÄ±cÄ±ya baÅŸarÄ±lÄ± mesajÄ± gÃ¶ster
            success_message = ChatMessage("API anahtarÄ±nÄ±z baÅŸarÄ±yla deÄŸiÅŸtirildi.", is_user=False)
            self.messages_layout.addWidget(success_message)
            
            # Otomatik olarak en aÅŸaÄŸÄ±ya kaydÄ±r
            QApplication.processEvents()
            self.messages_area.verticalScrollBar().setValue(
                self.messages_area.verticalScrollBar().maximum()
            )

    def button_style(self, color):
        return f"""
            QPushButton {{
                background-color: {color};
                color: white;
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 14px;
            }}
            QPushButton:hover {{
                background-color: {color}cc;
            }}
        """

    def send_message(self):
        user_text = self.chat_input.text().strip()
        if not user_text:
            return
            
        # KullanÄ±cÄ± mesajÄ±nÄ± ekle
        user_message = ChatMessage(user_text, is_user=True)
        self.messages_layout.addWidget(user_message)
        
        # GiriÅŸ alanÄ±nÄ± temizle
        self.chat_input.clear()
        
        # AI yanÄ±tÄ± (normalde burada Gemini API'ye istek atÄ±lÄ±r)
        self.get_ai_response(user_text)
        
        # Otomatik olarak en aÅŸaÄŸÄ±ya kaydÄ±r
        QApplication.processEvents()
        self.messages_area.verticalScrollBar().setValue(
            self.messages_area.verticalScrollBar().maximum()
        )

    def get_ai_response(self, user_input):
        try:
            response = genai.GenerativeModel("gemini-1.5-flash").generate_content([user_input])
            ai_text = response.text.strip()
            
            # AI mesajÄ±nÄ± ekle
            ai_message = ChatMessage(ai_text, is_user=False)
            self.messages_layout.addWidget(ai_message)
        except Exception as e:
            error_message = ChatMessage(f"Bir hata oluÅŸtu: {str(e)}", is_user=False)
            self.messages_layout.addWidget(error_message)

    def open_file(self):
        options = QFileDialog.Options()
        file_path, _ = QFileDialog.getOpenFileName(self, "Bir GÃ¶rsel SeÃ§in", "", "Images (*.png *.jpg *.jpeg *.bmp)", options=options)

        if file_path:
            self.preview_image(file_path)
            self.current_image_path = file_path
            self.analyze_button.setEnabled(True)  # GÃ¶rsel yÃ¼klendiÄŸinde analiz butonunu aktif et

    def preview_image(self, image_path):
        try:
            image = Image.open(image_path)
            image.thumbnail((400, 300))  # Boyutu sÄ±nÄ±rla
            
            # GÃ¶rseli PyQt5 uyumlu hale getir
            qimage = QImage(image_path)
            pixmap = QPixmap.fromImage(qimage).scaled(400, 300, Qt.KeepAspectRatio, Qt.SmoothTransformation)
            
            self.image_preview.setPixmap(pixmap)
            self.image_preview.show()
            
            # Resim yÃ¼klendi mesajÄ±
            message = ChatMessage(f"GÃ¶rsel yÃ¼klendi: {image_path.split('/')[-1]}", is_user=True)
            self.messages_layout.addWidget(message)
            
            # Otomatik olarak en aÅŸaÄŸÄ±ya kaydÄ±r
            QApplication.processEvents()
            self.messages_area.verticalScrollBar().setValue(
                self.messages_area.verticalScrollBar().maximum()
            )
        except Exception as e:
            error_message = ChatMessage(f"GÃ¶rsel yÃ¼klenirken bir hata oluÅŸtu: {str(e)}", is_user=False)
            self.messages_layout.addWidget(error_message)

    def analyze_image_with_ai(self):
        if not self.current_image_path:
            message = ChatMessage("LÃ¼tfen Ã¶nce bir gÃ¶rsel yÃ¼kleyin!", is_user=False)
            self.messages_layout.addWidget(message)
            return
            
        try:
            # Analiz iÅŸlemi baÅŸladÄ± mesajÄ±
            self.process_message = ChatMessage("GÃ¶rsel analiz ediliyor...", is_user=False)
            self.messages_layout.addWidget(self.process_message)
            
            # Otomatik olarak en aÅŸaÄŸÄ±ya kaydÄ±r
            QApplication.processEvents()
            self.messages_area.verticalScrollBar().setValue(
                self.messages_area.verticalScrollBar().maximum()
            )
            
            # GÃ¶rsel analizi iÃ§in Gemini'ye istek gÃ¶nder
            def analyze_thread():
                try:
                    image = Image.open(self.current_image_path)
                    model = genai.GenerativeModel('gemini-2.0-flash')
                    response = model.generate_content(["Bu gÃ¶rseli analiz et ve aÃ§Ä±kla.", image])
                    analysis_text = response.text
                    
                    # Sinyali kullanarak UI'Ä± gÃ¼ncelle
                    self.ui_signals.update_ui.emit({"type": "image_analysis", "text": analysis_text})
                    
                except Exception as e:
                    # Hata durumunda sinyali kullanarak hata mesajÄ± gÃ¶ster
                    self.ui_signals.show_error.emit(f"GÃ¶rsel analiz edilirken bir hata oluÅŸtu: {str(e)}", self.process_message)
            
            # Analiz iÅŸlemini ayrÄ± bir thread'de baÅŸlat
            threading.Thread(target=analyze_thread, daemon=True).start()
            
        except Exception as e:
            error_message = ChatMessage(f"GÃ¶rsel analiz edilirken bir hata oluÅŸtu: {str(e)}", is_user=False)
            self.messages_layout.addWidget(error_message)
    
    def take_screenshot(self):
        """Manuel olarak ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma ve analiz etme"""
        try:
            # Bilgi mesajÄ±
            self.info_message = ChatMessage("Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alÄ±nÄ±yor...", is_user=False)
            self.messages_layout.addWidget(self.info_message)
            
            # Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma ve kaydetme iÅŸlemi
            timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            screenshot_path = os.path.join(self.screenshot_dir, f"screenshot_{timestamp}.png")
            
            # Uygulama kÄ±sa sÃ¼reliÄŸine minimize edilir (opsiyonel)
            self.showMinimized()
            time.sleep(0.5)  # EkranÄ±n minimize olmasÄ± iÃ§in kÄ±sa bir bekleme
            
            # Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma
            screenshot = pyautogui.screenshot()
            screenshot.save(screenshot_path)
            
            # UygulamayÄ± tekrar gÃ¶ster
            self.showNormal()
            
            # Analiz etmek iÃ§in gÃ¶rÃ¼ntÃ¼yÃ¼ yÃ¼kle ve analiz et
            self.current_image_path = screenshot_path
            self.analyze_screenshot(screenshot_path, self.info_message)
            
        except Exception as e:
            error_message = ChatMessage(f"Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alÄ±nÄ±rken bir hata oluÅŸtu: {str(e)}", is_user=False)
            self.messages_layout.addWidget(error_message)
    
    def take_auto_screenshot(self):
        """Otomatik olarak ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma ve analiz etme"""
        try:
            # Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma ve kaydetme iÅŸlemi
            timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            screenshot_path = os.path.join(self.screenshot_dir, f"auto_screenshot_{timestamp}.png")
            
            # Uygulama minimize edilir (opsiyonel)
            self.showMinimized()
            time.sleep(0.5)  # EkranÄ±n minimize olmasÄ± iÃ§in kÄ±sa bir bekleme
            
            # Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma
            screenshot = pyautogui.screenshot()
            screenshot.save(screenshot_path)
            
            # UygulamayÄ± tekrar gÃ¶ster
            self.showNormal()
            
            # Bilgi mesajÄ±
            self.info_message = ChatMessage(f"Otomatik ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alÄ±ndÄ±: {timestamp}", is_user=False)
            self.messages_layout.addWidget(self.info_message)
            
            # Analiz et
            self.current_image_path = screenshot_path
            self.analyze_screenshot(screenshot_path, self.info_message, is_auto=True)
            
        except Exception as e:
            error_message = ChatMessage(f"Otomatik ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alÄ±nÄ±rken bir hata oluÅŸtu: {str(e)}", is_user=False)
            self.messages_layout.addWidget(error_message)
    
    def analyze_screenshot(self, screenshot_path, info_message=None, is_auto=False):
        """Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ analiz eden fonksiyon"""
        try:
            def analyze_thread():
                try:
                    image = Image.open(screenshot_path)
                    model = genai.GenerativeModel('gemini-2.0-flash')
                    
                    if is_auto:
                        prompt = [
                            "Bu bir ekran gÃ¶rÃ¼ntÃ¼sÃ¼dÃ¼r. LÃ¼tfen ÅŸunlarÄ± yap:"
                            "1. Ekranda ne olduÄŸunu kÄ±saca aÃ§Ä±kla"
                            "2. KullanÄ±cÄ±nÄ±n ne yaptÄ±ÄŸÄ±nÄ± tahmin et"
                            "3. KullanÄ±cÄ±ya faydalÄ± ipuÃ§larÄ± ve Ã¶neriler ver"
                            "4. KullanÄ±cÄ±nÄ±n daha verimli Ã§alÄ±ÅŸmasÄ± iÃ§in tavsiyelerde bulun"
                            "YanÄ±tÄ±nÄ± TÃ¼rkÃ§e olarak, madde madde ve rehber formatÄ±nda hazÄ±rla.",
                            image
                        ]
                    else:
                        prompt = ["Bu ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ detaylÄ± olarak analiz et ve eÄŸer gÃ¶rÃ¼ntÃ¼de kod varsa kodda hata vs. varsa uyar", image]
                    
                    response = model.generate_content(prompt)
                    analysis_text = response.text
                    
                    # Sinyali kullanarak UI'Ä± gÃ¼ncelle
                    data = {
                        "type": "screenshot_analysis", 
                        "text": analysis_text, 
                        "is_auto": is_auto,
                        "info_message": info_message
                    }
                    self.ui_signals.update_ui.emit(data)
                    
                except Exception as e:
                    # Hata durumunda sinyali kullanarak hata mesajÄ± gÃ¶ster
                    self.ui_signals.show_error.emit(f"Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ analiz edilirken bir hata oluÅŸtu: {str(e)}", info_message)
            
            # Analiz iÅŸlemini ayrÄ± bir thread'de baÅŸlat
            threading.Thread(target=analyze_thread, daemon=True).start()
            
        except Exception as e:
            error_message = ChatMessage(f"Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ analiz iÅŸlemi baÅŸlatÄ±lÄ±rken bir hata oluÅŸtu: {str(e)}", is_user=False)
            self.messages_layout.addWidget(error_message)
    
    def on_update_ui(self, data):
        """UI gÃ¼ncellemelerini yapan metot (Sinyal tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r)"""
        try:
            if data["type"] == "image_analysis":
                result_message = ChatMessage(data["text"], is_user=False)
                self.messages_layout.addWidget(result_message)
                
                # Process mesajÄ±nÄ± kaldÄ±r
                self.messages_layout.removeWidget(self.process_message)
                self.process_message.deleteLater()
                
            elif data["type"] == "screenshot_analysis":
                info_message = data["info_message"]
                if info_message:
                    # Mevcut bilgi mesajÄ±nÄ± kaldÄ±r
                    self.messages_layout.removeWidget(info_message)
                    info_message.deleteLater()
                
                if data["is_auto"]:
                    title = f"ðŸ–¥ï¸ EKRAN ANALÄ°Z RAPORU ({datetime.datetime.now().strftime('%H:%M')})"
                    result_message = ChatMessage(f"{title}\n\n{data['text']}", is_user=False)
                else:
                    result_message = ChatMessage(data["text"], is_user=False)
                    
                self.messages_layout.addWidget(result_message)
            
            # Otomatik olarak en aÅŸaÄŸÄ±ya kaydÄ±r
            self.messages_area.verticalScrollBar().setValue(
                self.messages_area.verticalScrollBar().maximum()
            )
        except Exception as e:
            print(f"UI gÃ¼ncelleme hatasÄ±: {e}")
    
    def on_show_error(self, error_text, info_message=None):
        """Hata mesajlarÄ±nÄ± gÃ¶steren metot (Sinyal tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r)"""
        try:
            error_message = ChatMessage(error_text, is_user=False)
            self.messages_layout.addWidget(error_message)
            
            if info_message:
                # Bilgi mesajÄ±nÄ± kaldÄ±r
                self.messages_layout.removeWidget(info_message)
                info_message.deleteLater()
                
            # Otomatik olarak en aÅŸaÄŸÄ±ya kaydÄ±r
            self.messages_area.verticalScrollBar().setValue(
                self.messages_area.verticalScrollBar().maximum()
            )
        except Exception as e:
            print(f"Hata gÃ¶sterme hatasÄ±: {e}")
    
    def toggle_auto_screenshot(self, state):
        """Otomatik ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma Ã¶zelliÄŸini aÃ§Ä±p kapatÄ±r"""
        if state == Qt.Checked:
            # Otomatik ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma Ã¶zelliÄŸini aktifleÅŸtir
            self.is_auto_screenshot_enabled = True
            self.screenshot_timer.start(60000)  # 60000 ms = 1 dakika
            
            # Bilgi mesajÄ±
            info_message = ChatMessage("Otomatik ekran analizi baÅŸlatÄ±ldÄ±. Dakikada bir analiz yapÄ±lacak.", is_user=False)
            self.messages_layout.addWidget(info_message)
            
            # Ä°lk ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ hemen al
            QTimer.singleShot(1000, self.take_auto_screenshot)
            
        else:
            # Otomatik ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alma Ã¶zelliÄŸini devre dÄ±ÅŸÄ± bÄ±rak
            self.is_auto_screenshot_enabled = False
            self.screenshot_timer.stop()
            
            # Bilgi mesajÄ±
            info_message = ChatMessage("Otomatik ekran analizi durduruldu.", is_user=False)
            self.messages_layout.addWidget(info_message)

if __name__ == '__main__':
    app = QApplication(sys.argv)
    ex = App()
    ex.show()
    sys.exit(app.exec_())